# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## üîó CRITICAL REQUIREMENT: ALWAYS PROVIDE LOCALHOST LINK

**AFTER RUNNING `npm run dev`, ALWAYS PROVIDE THIS LINK TO THE USER:**
### http://localhost:3000

This is a standard 100% requirement for ALL projects. Never omit the localhost link.

## Commands

```bash
# Install dependencies
npm install

# Process CSV data into categorized JSON (required before first run)
npm run process-data

# Test all layer endpoints for availability (updates layer-test-results.json)
npm run test-layers

# Start development server
npm run dev
# THEN ALWAYS PROVIDE: http://localhost:3000

# Build for production
npm run build

# Run linter
npm run lint

# Deploy to GitHub Pages (uncomment export/basePath in next.config.js first)
git push origin main
```

## Data Processing Pipeline Architecture

The application uses a two-stage data processing pipeline that must be understood to make architectural changes:

### Stage 1: CSV Processing (`scripts/process-data.js`)
1. Reads `public/HIFLD_Open_Crosswalk_Geoplatform.csv` (305 infrastructure layers)
2. Categorizes layers based on keywords in layer names
3. Outputs `public/processed-layers.json` with structure:
   - `layers`: Array of all layers with categories
   - `categorized`: Layers grouped by category
   - `stats`: Summary statistics

### Stage 2: Layer Testing (`scripts/test-layers.js`)
1. Reads `processed-layers.json`
2. Tests each layer's service endpoint with lenient validation:
   - Accepts ANY 200 response as working
   - Tries multiple URL formats (plain, ?f=json, ?f=pjson)
   - 10-second timeout per request
3. Outputs `public/layer-test-results.json` with:
   - `results`: All layers with test status
   - `stats`: Working/failed/restricted counts
   - Test statuses: 'working', 'failed', 'restricted', 'no_url', 'timeout', 'unreachable'

### Stage 3: Runtime Loading
The React app (`src/app/page.tsx`) loads data in priority order:
1. First tries `/layer-test-results.json` (has test results)
2. Falls back to `/processed-layers.json` (no test results)
3. All filtering/searching happens client-side on loaded data

## Component Architecture

### State Management Flow
All state lives in `src/app/page.tsx` and flows down through props:

```
page.tsx (orchestrator)
‚îú‚îÄ‚îÄ State: allLayers, filteredLayers, selectedLayers, filters
‚îú‚îÄ‚îÄ Data loading: loadLayerData() ‚Üí fetch JSON files
‚îî‚îÄ‚îÄ Components:
    ‚îú‚îÄ‚îÄ SearchBar ‚Üí updates searchQuery state
    ‚îú‚îÄ‚îÄ Category dropdown ‚Üí updates selectedCategory state  
    ‚îú‚îÄ‚îÄ LayerList ‚Üí displays filteredLayers, calls onAddLayer
    ‚îú‚îÄ‚îÄ MapView ‚Üí renders selectedLayers on ArcGIS map
    ‚îî‚îÄ‚îÄ ExportMapButton ‚Üí exports selectedLayers config
```

### Layer Selection Flow
1. User interacts with LayerList component
2. LayerList calls `onAddLayer(layer)` callback
3. page.tsx adds to `selectedLayers` state
4. MapView re-renders with new layers
5. Only layers with `testStatus === 'working'` are sent to MapView

## Key Architectural Decisions

### Why Node.js Scripts Instead of API Routes
- GitHub Pages deployment requires static export (`output: 'export'`)
- Static export disables Next.js API routes and middleware
- Data processing happens at build time, not runtime
- Results are served as static JSON files

### Layer Testing Strategy
The test script (`scripts/test-layers.js`) is intentionally lenient:
- Previous strict validation rejected many working layers
- Now accepts ANY 200 HTTP response
- Tests all 305 layers (not just first 100)
- Results: 254 working, 51 restricted, 0 failed

### Deployment Configuration
`next.config.js` has two modes:
```javascript
// Local development (current):
// output: 'export',  // Commented out
// basePath: '/infrastructure-tool-v2',  // Commented out

// GitHub Pages deployment:
output: 'export',  // Uncomment these
basePath: '/infrastructure-tool-v2',  // Uncomment these
```

## Critical Files and Their Roles

- `public/HIFLD_Open_Crosswalk_Geoplatform.csv` - Source data, DO NOT MODIFY
- `public/processed-layers.json` - Generated by process-data.js
- `public/layer-test-results.json` - Generated by test-layers.js  
- `lib/layerCategories.ts` - Category definitions and categorization logic
- `src/app/page.tsx` - Main orchestrator, all state management
- `src/components/LayerList.tsx` - Renders categorized layers with status indicators
- `src/components/MapView.tsx` - ArcGIS map integration, dynamic imports for performance

## Layer Categories

Defined in `lib/layerCategories.ts` and `scripts/process-data.js`:
- Emergency Services
- Healthcare  
- Education
- Energy
- Transportation
- Communications
- Government
- Critical Facilities
- Maritime
- Utilities
- Boundaries
- Other (fallback)

## Testing Results (Current)

After running `npm run test-layers`:
- Total Layers: 305
- ‚úÖ Working: 254 (83%)
- üîí Restricted: 51 (17%)
- ‚ùå Failed: 0

## Known Constraints

1. **No middleware with static export** - Password protection disabled for GitHub Pages
2. **CORS limitations** - Some layers fail client-side despite passing server tests
3. **Large initial load** - All 305 layers loaded into memory on app start
4. **No server-side filtering** - All search/filter operations are client-side

## User Requirements

1. **Always provide complete file replacements** - Never partial edits
2. **Always commit to GitHub** for deployment
3. **Always provide localhost link** after starting dev server
4. **Test accessibility** - Many layers previously worked, don't be too strict